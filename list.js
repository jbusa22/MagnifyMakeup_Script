const findBannedChemicals = () => {
let mysql  = require('promise-mysql');
const request = require("request-promise");
var config = {
    host    : 'magnifymakeup.com',
    user    : 'magnifym_JACKB',
    password: 'x3YX4uQXu3WzXFg',
    database: 'magnifym_productresults'
  };
const processSQL = async () =>
{
    let pool = await mysql.createPool(config);
    let connection = await pool.getConnection();
    // insert statment
    var query_str =
    "SELECT * " +
    "FROM chemical " +
    "WHERE cas != 'NI' ";
    let resin = await connection.query(query_str);
    let eu = await request("https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=uriserv:OJ.L_.2009.342.01.0059.01.ENG&toc=OJ:L:2009:342:FULL");
    let html = eu.match(/[\S\s]*LIST OF SUBSTANCES WHICH COSMETIC PRODUCTS MUST NOT CONTAIN EXCEPT SUBJECT TO THE RESTRICTIONS LAID DOWN/);
    let regex = /<tr class="table">[\S\s]*?([\d]*-[\d]*-[\d]*)[\s]*?</g;
    let matchArray = getMatches(html, regex);
    // execute the insert statment
    //let newProductId = res1.insertId;
     let here = JSON.stringify(resin);
     let ba = JSON.parse(here);
    for(let i = 0; i < ba.length; i++)
    {

        if(getmorebad(ba[i].cas) == "yes")
        {
            console.log("yes2");
            let setmoreBad = `INSERT INTO LIST( CHEMID, LIST)
                    VALUES(?,?)`;
            let bad = [ ba[i].id, "California Prop 65"];
            let updatemoreCas = await connection.query(setmoreBad, bad);
        }
        for(let j = 0; j < matchArray.length; j++)
        {
            if(matchArray[j] == ba[i].cas)
            {
                console.log("yes");
                let setevenmoreBad = `INSERT INTO LIST( CHEMID, LIST)
                    VALUES(?,?)`;
                let wowbad = [ ba[i].id, "EU "];
                let updatemoreCas = await connection.query(setevenmoreBad, wowbad);
            }
            
        }
    }
    pool.releaseConnection(connection);
    pool.end();
}

function getMatches(string, regex, index) 
{
    index || (index = 1); // default to the first capturing group
    var matches = [];
    var match;
    while (match = regex.exec(string)) {
      matches.push(match[index]);
    }
    return matches;
}

function getmorebad(cas) {
    let badchemicals = "26148-68-5,154229-18-2,60-35-5,75-07-0,59-66-5,34256-82-1,546-88-3,53-96-3,62476-59-9,79-06-1,79-06-1,107-13-1,50-76-0,50-76-0,3688-53-7,15972-60-8,309-00-2,302-79-4,107-05-1,28981-97-7,645-05-6,665-66-7,39831-55-5,117-79-3,60-09-3,97-56-3,92-67-1,81-49-2,6109-97-3,153-78-6,125-84-8,82-28-0,712-68-5,119-34-6,54-62-6,19774-82-4,33089-61-1,61-82-5,14028-44-5,51264-14-3,994-05-8,63-05-8,62-53-3,142-04-1,90-04-0,134-29-2,117-37-3,84-65-1,1309-64-4,140-57-8,1332-21-4,50-78-2,29122-68-7,1912-24-9,492-80-8,34031-32-8,71751-41-2,320-67-2,115-02-6,446-86-6,446-86-6,103-33-3,9-8-5534,17804-35-2,177406-68-7,56-55-3,71-43-2,71-43-2,92-87-5,205-99-2,205-82-3,207-08-9,271-89-6,119-61-9,50-32-8,98-07-7,5411-22-3,100-44-7,1694-09-3,3296-90-0,111-44-4,494-03-1,154-93-8,154-93-8,542-88-1,80-05-7,80-05-7,53404-19-6,53404-19-6,15541-45-4,5589-96-8,71133-14-7,75-27-4,74-96-4,75-25-2,106-94-5,106-94-5,75-26-3,1689-84-5,1689-99-2,143-81-7,106-99-0,106-99-0,55-98-1,55-98-1,25013-16-5,85-68-7,8/6/2426,3068-88-0,75-60-5,331-39-5,6/1/2425,133-06-2,298-46-4,63-25-2,63-25-2,86-74-8,1333-86-4,75-15-0,630-08-0,56-23-5,41575-94-4,60391-92-6,120-80-9,474-25-9,75-87-6,302-17-0,305-03-3,305-03-3,56-75-7,982-57-0,1620-21-9,57-74-9,143-50-0,143-50-0,58-25-3,438-41-5,6164-98-3,115-28-6,108171-26-2,106-47-8,20265-96-7,124-48-1,75-00-3,13010-47-4,13010-47-4,13909-09-6,67-66-3,67-66-3,107-30-2,563-47-3,100-00-5,95-83-0,126-99-8,598-78-7,1897-45-6,95-69-2,569-57-3,54749-90-5,2921-88-2,64902-72-3,218-01-9,6459-94-5,569-61-9,2429-74-5,28407-37-6,2832-40-8,842-07-9,59865-13-3,79217-60-0,113852-37-2,87-29-6,15663-27-1,6358-53-8,4291-63-8,81103-11-9,25122-46-7,637-07-0,50-41-9,50-41-9,57109-90-7,6814-58-0,7440-48-4,1307-96-6,10124-43-3,10026-24-1,50-36-2,52-28-8,64-86-8,120-71-8,98-82-8,135-20-6,21725-46-2,14901-08-7,1134-23-2,108-93-0,66-81-9,27208-37-3,50-18-0,50-18-0,6055-19-2,6055-19-2,13121-70-5,147-94-4,21739-91-3,3468-63-1,2092-56-0,2-1-5160,81-88-9,3-4-4342,3-4-4342,1596-84-5,17230-88-5,117-10-2,20830-81-3,23541-50-6,94-82-6,72-54-8,72-55-9,50-29-3,789-02-6,50-29-3,62-73-7,64-73-3,6190-65-4,1007-28-9,613-35-4,615-05-4,39156-41-7,3397-62-4,101-80-4,95-80-7,439-14-5,136-35-6,364-98-7,226-36-8,224-42-0,215-58-7,53-70-3,224-41-9,194-59-2,192-65-4,189-64-0,189-55-9,191-30-0,631-64-1,3252-43-5,96-12-8,96-12-8,96-13-9,79-43-6,79-43-6,106-46-7,91-94-1,612-83-9,72-55-9,764-41-0,28434-86-8,75-34-3,75-09-2,97-23-4,120-97-8,78-87-5,96-23-1,542-75-6,51338-27-3,51338-27-3,66-76-2,60-57-1,84-17-3,1464-53-5,111-42-2,117-81-7,117-81-7,1615-80-1,56-53-1,56-53-1,64-67-5,22494-42-4,7-5-2238,101-90-6,6190-39-2,94-58-6,68515-49-1,26761-40-0,10-6-2973,33286-22-5,119-90-4,20325-40-0,127-19-5,60-11-7,55738-54-0,57-97-6,119-93-7,612-82-8,79-44-7,68-12-2,57-14-7,540-73-8,1456-28-6,77-78-1,99-97-8,513-37-1,84-74-2,84-75-3,99-65-0,528-29-0,100-25-4,105735-71-5,22506-53-2,75321-20-9,42397-64-8,42397-65-9,121-14-2,121-14-2,606-20-2,606-20-2,39300-45-3,88-85-7,136-45-8,123-91-1,57-41-0,57-41-0,630-93-3,1937-37-7,2602-46-2,16071-86-6,138-93-2,2475-45-8,330-54-1,25316-40-9,25316-40-9,564-25-0,94088-85-4,24390-14-5,17086-28-1,120-36-5,72-20-8,106-89-8,106-89-8,135319-73-2,379-79-3,12510-42-8,66733-21-9,50-28-2,140-67-0,53-16-7,7280-37-7,57-63-6,536-33-4,13194-48-4,140-88-5,100-41-4,637-92-3,759-94-4,510-15-6,106-93-4,106-93-4,107-06-2,107-21-1,110-80-5,111-15-9,109-86-4,110-49-6,151-56-4,75-21-8,75-21-8,75-21-8,96-45-7,96-45-7,149-57-5,62-50-0,41340-25-4,33419-42-0,33419-42-0,54350-48-0,66441-23-4,72490-01-8,121181-53-1,69806-50-4,3-3-3385,51-21-8,76-43-7,1172-18-5,5104-49-4,13311-84-7,80474-14-2,69409-94-5,133-07-3,50-00-0,3570-75-0,116355-83-0,110-00-9,67-45-8,98-00-0,60568-05-0,79748-81-5,1303-00-0,82410-32-0,107910-75-8,25812-30-0,25812-30-0,548-62-9,67730-11-4,67730-10-3,765-34-4,556-52-5,1071-83-6,65807-02-5,126-07-8,16568-02-8,23092-17-3,66852-54-8,52-86-8,151-67-7,2784-94-3,76-44-8,76-44-8,1024-57-3,118-74-1,118-74-1,87-68-3,34465-46-8,67-72-1,684-16-2,680-31-9,680-31-9,110-54-3,110-13-4,67485-29-4,302-01-2,10034-93-2,122-66-7,129-43-1,127-07-1,57852-57-0,3778-73-2,10043-66-0,35554-44-0,193-39-5,22398-80-7,76180-96-6,36734-19-7,140923-17-7,140923-25-7,9004-66-4,542-56-3,78-79-5,881685-58-1,120-58-1,4759-48-2,141112-29-0,143390-89-0,77501-63-4,303-34-4,301-04-2,7446-27-7,1335-32-6,74381-53-6,59-92-7,797-63-7,330-55-2,554-13-2,919-16-4,846-49-1,75330-75-5,52-76-6,121-75-5,24382-04-5,1-7-8018,12427-38-2,68006-83-7,31431-39-7,71-58-9,71-58-9,595-33-5,595-33-5,77094-11-2,77500-04-0,148-82-3,148-82-3,9002-68-0,110235-47-7,57-53-4,149-30-4,6112-76-1,531-76-0,72-33-3,137-41-7,3963-95-9,137-42-8,137-42-8,67-56-1,20354-26-1,60-56-0,59-05-2,15475-56-6,484-20-8,298-81-7,75-55-8,590-96-5,592-62-1,74-83-9,598-55-0,74-87-3,74-87-3,56-49-5,3697-24-3,101-14-4,101-61-1,838-88-0,101-77-9,13552-44-8,93-15-2,693-98-1,822-36-6,74-88-4,108-10-1,108-10-1,624-83-9,563-80-4,66-27-3,591-78-6,591-78-6,129-15-7,70-25-7,924-42-5,872-50-4,98-83-9,98-83-9,58-18-4,56-04-2,9006-42-2,9006-42-2,443-48-1,90-94-8,59467-96-8,13614-98-7,2385-85-5,59122-46-2,50-07-7,70476-82-3,70476-82-3,2212-67-1,71526-07-3,121776-33-8,96-24-2,315-22-0,113803-47-7,139-91-3,505-60-2,77439-76-0,88671-89-0,123-35-3,142-59-6,86220-42-0,3771-19-5,389-08-2,91-20-3,134-32-7,91-59-8,1405-10-3,56391-57-2,7440-02-0,373-02-4,3333-67-3,13463-39-3,13463-39-3,12054-48-7,12125-56-3,1271-28-9,1313-99-1,12035-72-2,54-11-5,21829-25-4,66085-59-4,61-57-4,1929-82-4,1929-82-4,139-13-9,18662-53-8,602-87-9,99-59-2,91-23-6,98-95-3,98-95-3,92-93-3,2-8-7496,1836-75-5,607-57-8,67-20-9,59-87-0,555-84-0,531-82-8,51-75-2,51-75-2,55-86-7,55-86-7,126-85-2,302-70-5,75-52-5,79-46-9,5522-43-0,57835-92-4,924-16-3,1116-54-7,55-18-5,62-75-9,156-10-5,86-30-6,621-64-7,759-73-9,932-83-2,60153-49-3,64091-91-4,7068-83-9,75881-22-0,55090-44-3,10595-95-6,16338-99-1,28538-70-7,75881-19-5,34423-54-6,13256-07-0,924-46-9,75881-20-8,68107-26-6,684-93-5,615-53-2,4549-40-0,59-89-2,16543-55-8,100-75-4,930-55-2,13256-22-9,88-72-2,10024-97-2,68-22-4,68-22-4,51-98-9,68-22-4,57-63-6,68-22-4,72-33-3,68-23-5,6533-00-2,303-47-9,2646-17-5,19044-88-3,19666-30-9,19666-30-9,604-75-1,604-75-1,80-51-3,301-12-2,434-07-1,434-07-1,79-57-2,2058-46-0,1-2-2439,1-2-2439,33069-62-4,12174-11-7,794-93-4,115-67-3,56-38-2,52-67-5,87-86-5,57-33-0,53910-25-1,1763-23-1,335-67-1,380610-27-5,63-98-9,62-44-2,94-78-0,136-40-3,10-9-3546,50-06-6,77-09-8,59-96-1,63-92-3,435-97-2,95-54-5,122-60-1,122-60-1,132-27-4,90-43-7,638-21-1,105650-23-5,2062-78-4,111025-46-8,54-91-1,23103-98-2,18378-89-7,53973-98-1,3761-53-3,9-8-3564,1-2-7758,128-03-0,81131-70-6,125-02-0,125-33-7,671-16-9,366-70-1,366-70-1,32809-16-8,57-83-0,23950-58-5,1918-16-7,1120-71-4,2312-35-8,2312-35-8,139-40-2,57-57-8,114-26-1,57018-52-7,75-56-9,51-52-5,51-52-5,89-82-7,123312-89-0,110-86-1,58-14-0,36735-22-5,76578-14-8,50-55-5,10453-86-8,10453-86-8,36791-04-5,36791-04-5,23246-96-0,13292-46-1,81-07-2,128-44-9,94-59-7,309-43-3,874967-67-6,7446-34-6,68308-34-9,122-34-9,128-04-1,62-74-8,148477-71-8,52-01-7,10418-03-8,10048-13-2,3810-74-0,18883-66-4,18883-66-4,100-42-5,96-09-3,95-06-7,599-79-1,599-79-1,9-5-7446,38194-50-2,10540-29-1,54965-24-1,846-50-4,29767-20-2,5902-51-2,52232-67-4,2593-15-9,58-22-0,58-20-8,315-37-7,79-94-7,14047-09-7,1746-01-6,1746-01-6,630-20-6,79-34-5,127-18-4,5216-25-1,22248-79-9,60-54-8,64-75-5,116-14-3,509-14-8,50-35-1,62-55-5,139-65-1,59669-26-0,154-42-7,23564-05-8,141-90-2,62-56-6,1314-20-1,49842-07-1,108-88-3,108-88-3,26471-62-5,95-53-4,636-21-5,106-49-0,97240-79-4,8001-35-2,299-75-2,43121-43-3,396-01-0,28911-01-5,78-48-8,2155-70-6,817-09-4,76-03-9,79-01-6,79-01-6,88-06-2,96-18-4,38260-01-4,26644-46-2,2451-62-9,13647-35-3,127-48-0,512-56-1,82952-64-5,118-96-7,76-87-9,76-87-9,68-76-8,52-24-4,115-96-8,126-72-7,13674-87-8,62450-06-0,62450-07-1,72-57-1,66-75-1,66-75-1,51-79-6,51-79-6,97048-13-0,99-66-1,1314-62-1,143-67-9,50471-44-8,50471-44-8,2068-78-2,593-60-2,75-01-4,100-40-3,100-40-3,106-87-6,106-87-6,75-02-5,75-35-4,79-00-5,879085-55-9,81-81-2,87-62-7,7481-89-2,30516-87-1,111406-87-2,12122-67-7";
    if(badchemicals.match(cas))
    {
        return "yes";
    }
    else
    {
        return "No";
    }
}
return {
    processSQL : processSQL
}

}

module.exports = findBannedChemicals();